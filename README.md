# 代理池
# 需求
## 为什么需要代理
1. 目前公司有大量抓取业务需求，许多门户网站针对代理做了一定的反爬机制
2. 抓取数据描述：主要针对内容行业国内，国外门户网站抓取
## 代理来源
1. 目前代理主要是通过第三方提供短效IP
## 为什么需要建立代理池
1. 考虑第三方提供代理可用性达到80%，有20%不可用，而且代理质量不是太好。需要进行代理池失效性检查。
2. 目前代理来源是短效IP，考虑到为提高抓取质量后期需要长效IP
3. 目前抓取业务有对国外网站抓取，需要能针对域名进行国外，国内IP分派
## 项目目标
1. 为公司所有抓取业务提供高质量的代理IP需求
2. 在单节点服务支持下提供400r/s的吞吐支持，预测资源占比500m,512Mi
## 项目一期需求
1. 针对短效IP定时设置自检，过滤掉无效IP
2. 判断域名所在区域，并分派IP
## 技术方案

### 代理IP以及质量维护
1. 通过第三方接口定时提取代理IP，并存入数据库。
2. 定时任务定时扫描代理IP并根据适用区域选择不同的URL地址进行有效性检查
3. 针对失效的IP进行删除清洗

### 代理IP查询服务支持
1. 提供代理IP查询服务支持，服务通过用户传递的域名进行区域判别，从而选择指定区域IP列表并通过随机算法提取其中一个代理IP交付用户
2. 通过用户传递的域名加入域名管理计划

### 域名管理计划
1.消息队列接受来自代理查询服务的域名，通过查询数据库是否已经是识别域名，对于未识别域名进行区域识别，并存入数据库。

## 技术方案详述
### 代理IP以及质量维护

**数据库表结构**
proxy_pools
| 字段         | 类型        | 特殊      | 描述                        |
| ------------ | ----------- | --------- | --------------------------- |
| id           | varchar(20) | 主键      | 通过代理(proxy字段)sha1生成 |
| proxy        | varchar(10) | Not Null  | 代理IP                      |
| is_long_time | int(1)      | default=0 | default(0)短效，=1长效      |
| is_cn        | int(1)      | default=0 | default(0)是国内，=1国外    |
| created_at        | int      |  | 创建时间  |
**业务流程**

![avatar](/Users/yunbaoma/Desktop/代理池IP模块流程.jpeg)

**代理IP查询服务支持**
![avatar](/Users/yunbaoma/Desktop/代理查询服务.jpeg)

**代理查询服务接口**

> Url: /proxy_pool/api/proxys?domain=baidu.con
>
> Method: GET
>
> Content-Type: application/json

####Params

domain=xxx.com

#### 返回数据格式

```json
{
  code: 0,
  data:{
       "proxy":"192.168.1.100:8080"
    },
  msg: "success"
}


```
### 域名管理计划
**数据库表结构**
domains
| 字段         | 类型        | 特殊      | 描述                        |
| ------------ | ----------- | --------- | --------------------------- |
| id           |int | 主键      | 自增 |
| domain        | varchar(20) | Not Null  | 域名                |
| is_cn        | int(1)      | default=0 | default(0)是国内，=1国外    |
| created_at        | int      |  | 创建时间  |

**消息队列**

`turing:domain:region`

**流程图**

![avatar](/Users/yunbaoma/Desktop/域名识别计划.jpeg)